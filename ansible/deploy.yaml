---
- name: Deploy Weather Application
  hosts: app
  become: yes
  vars:
    work_dir: /opt/sungraph
    # Default variable values (can be overridden by env vars)
    docker_user: "{{ lookup('env', 'DOCKER_HUB_USERNAME') }}"
    postgres_user: "{{ lookup('env', 'POSTGRES_USER') }}"
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    postgres_db: "{{ lookup('env', 'POSTGRES_DB') }}"
    api_key: "{{ lookup('env', 'WEATHER_API_KEY') }}"
  
  pre_tasks:
    - name: Login to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_user }}"
        password: "{{ lookup('env', 'DOCKER_HUB_TOKEN') }}"
  
  tasks:
    - name: Ensure working directory exists
      ansible.builtin.file:
        path: "{{ work_dir }}"
        state: directory
        mode: '0755'

    - name: Create docker-compose.yaml
      ansible.builtin.copy:
        dest: "{{ work_dir }}/docker-compose.yaml"
        content: |
          services:
            db:
              image: postgres:15-alpine
              container_name: weather-db
              networks:
                - core-infra
              environment:
                - POSTGRES_USER={{ postgres_user }}
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_DB={{ postgres_db }}
              volumes:
                - ./db_data:/var/lib/postgresql/data
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U {{ postgres_user }} -d {{ postgres_db }}"]
                interval: 5s
                timeout: 5s
                retries: 5

            backend:
              image: {{ docker_user }}/weather-backend:latest
              container_name: weather-backend
              networks:
                - core-infra
              environment:
                - DB_HOST=db
                - POSTGRES_USER={{ postgres_user }}
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_DB={{ postgres_db }}
                - API_KEY={{ api_key }}
              depends_on:
                db:
                  condition: service_healthy

            worker:
              image: {{ docker_user }}/weather-backend:latest
              container_name: weather-worker
              networks:
                - core-infra
              command: python worker.py
              environment:
                - DB_HOST=db
                - POSTGRES_USER={{ postgres_user }}
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_DB={{ postgres_db }}
                - API_KEY={{ api_key }}
              depends_on:
                backend:
                  condition: service_started
                db:
                  condition: service_healthy

            historical_worker:
              image: {{ docker_user }}/weather-backend:latest
              container_name: weather-historical-worker
              networks:
                - core-infra
              command: python historical_worker.py
              environment:
                - DB_HOST=db
                - POSTGRES_USER={{ postgres_user }}
                - POSTGRES_PASSWORD={{ postgres_password }}
                - POSTGRES_DB={{ postgres_db }}
                - API_KEY={{ api_key }}
              depends_on:
                backend:
                  condition: service_started
                db:
                  condition: service_healthy

            frontend:
              image: {{ docker_user }}/weather-frontend:latest
              container_name: weather-frontend
              networks:
                - core-infra
              #ports:
              #  - "5179:5173"
              restart: always
          
          networks:
            core-infra:
              external: true

        mode: '0644'

    - name: Pull and start containers
      community.docker.docker_compose_v2:
        project_src: "{{ work_dir }}"
        pull: always
        state: present
